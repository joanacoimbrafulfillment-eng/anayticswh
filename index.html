<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MURTEDE ‚Ä¢ Analytics</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a30; --muted:#8aa0c2; --text:#e8f0ff;
      --good:#35d07f; --warn:#ffcc66; --bad:#ff6b6b; --accent:#7aa7ff;
      --line: rgba(255,255,255,.08);
    }
    *{box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
    body{margin:0; background:linear-gradient(180deg,#071022, #0b1220 35%, #071022); color:var(--text);}
    a{color:var(--accent)}

    .wrap{max-width:1200px; margin:0 auto; padding:18px;}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:14px;}
    .brand{display:flex; flex-direction:column;}
    .brand b{font-size:18px; letter-spacing:.5px;}
    .brand span{color:var(--muted); font-size:12px;}

    .card{background:rgba(15,26,48,.92); border:1px solid var(--line); border-radius:16px; box-shadow: 0 12px 35px rgba(0,0,0,.35);}
    .pad{padding:16px;}

    .grid{display:grid; gap:14px;}
    .grid-2{grid-template-columns: 1fr 1fr;}
    .grid-3{grid-template-columns: repeat(3,1fr);} 
    @media (max-width: 980px){.grid-2,.grid-3{grid-template-columns:1fr;}}

    .btn{appearance:none; border:0; cursor:pointer; padding:10px 12px; border-radius:12px; color:var(--text);
      background:rgba(122,167,255,.16); border:1px solid rgba(122,167,255,.35);
      font-weight:650; letter-spacing:.2px;}
    .btn:hover{filter:brightness(1.08)}
    .btn.secondary{background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.14);}

    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
    input, select{width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06); color:var(--text); outline:none;}
    input:focus, select:focus{border-color:rgba(122,167,255,.55); box-shadow: 0 0 0 3px rgba(122,167,255,.16)}

    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;}
    .tab{padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06); color:var(--text); cursor:pointer; font-weight:650; font-size:12px;}
    .tab.active{background:rgba(122,167,255,.20); border-color:rgba(122,167,255,.55)}

    .kpis{display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; margin-top:14px;}
    @media(max-width:980px){.kpis{grid-template-columns:1fr 1fr;}}
    @media(max-width:520px){.kpis{grid-template-columns:1fr;}}
    .kpi{padding:12px; border-radius:14px; border:1px solid var(--line); background:rgba(255,255,255,.04)}
    .kpi .t{font-size:12px; color:var(--muted)}
    .kpi .v{font-size:22px; font-weight:800; margin-top:4px}

    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden;}
    th,td{padding:10px 10px; border-bottom:1px solid var(--line); text-align:left; font-size:13px;}
    th{position:sticky; top:0; background:rgba(15,26,48,.98); color:rgba(232,240,255,.92); z-index:2;}
    tr:hover td{background:rgba(255,255,255,.03)}

    .scroll{max-height:520px; overflow:auto; border:1px solid var(--line); border-radius:14px;}

    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px;
      border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06);}
    .pill.good{border-color:rgba(53,208,127,.45); background:rgba(53,208,127,.12)}
    .pill.warn{border-color:rgba(255,204,102,.45); background:rgba(255,204,102,.12)}

    .login{min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px;}
    .login-card{width:min(440px, 100%);} 
    .login h1{margin:0 0 8px 0; font-size:18px;}
    .login p{margin:0 0 16px 0; color:var(--muted); font-size:13px;}

    .hide{display:none !important;}
    .muted{color:var(--muted)}
  </style>
</head>
<body>

<div id="login" class="login">
  <div class="card pad login-card">
    <h1>MURTEDE ‚Ä¢ Analytics</h1>
    <p>Analytics dashboard: operator performance, top-selling products, and most-returned products.</p>

    <div class="grid" style="gap:10px;">
      <div>
        <label>Email</label>
        <input id="email" type="email" placeholder="@admin.com / @wh.com" />
      </div>
      <div>
        <label>Password</label>
        <input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <button class="btn" onclick="handleLogin()">SIGN IN</button>
      <div id="login-msg" class="muted" style="font-size:12px;"></div>
    </div>
  </div>
</div>

<div id="app" class="wrap hide">
  <div class="topbar">
    <div class="brand">
      <b>MURTEDE ‚Ä¢ Analytics</b>
      <span id="userline">User: -</span>
    </div>
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
      <span id="dbline" class="pill">DB: wh-murtede</span>
      <button class="btn secondary" onclick="auth.signOut()">Logout</button>
    </div>
  </div>

  <div class="card pad" style="margin-top:14px;">
    <div class="grid grid-3">
      <div>
        <label>Start date</label>
        <input type="date" id="start" />
      </div>
      <div>
        <label>End date</label>
        <input type="date" id="end" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn" onclick="runAnalytics()">RUN ANALYSIS</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="perf" onclick="showTab('perf')">üë• Performance</div>
      <div class="tab" data-tab="pick" onclick="showTab('pick')">üß∫ Picking</div>
      <div class="tab" data-tab="sold" onclick="showTab('sold')">üî• Top sold</div>
      <div class="tab" data-tab="ret" onclick="showTab('ret')">‚Ü©Ô∏è Top returns</div>
      <div class="tab" data-tab="ratio" onclick="showTab('ratio')">üìâ Return rate</div>
      <div class="tab" data-tab="carriers" onclick="showTab('carriers')">üöö Carriers</div>
      <div class="tab" data-tab="opprods" onclick="showTab('opprods')">üì¶ Products by operator</div>
      <div class="tab" data-tab="oprets" onclick="showTab('oprets')">‚Ü©Ô∏è Returns by operator</div>
      <div class="tab" data-tab="daycar" onclick="showTab('daycar')">üóìÔ∏è Products by day & carrier</div>
      <div class="tab" data-tab="offinv" onclick="showTab('offinv')">üìã OFF lotes (SKU/QTY)</div>
      <div class="tab" data-tab="export" onclick="showTab('export')">üìÅ Export</div>
      <span id="status" class="muted" style="margin-left:auto; font-size:12px;"></span>
    </div>

    <div class="kpis" id="kpis"></div>

    <div class="grid grid-2" style="margin-top:14px;">
      <div class="card pad" style="background:rgba(255,255,255,.03); border-radius:14px;">
        <b>Volume over time</b>
        <div style="height:260px; margin-top:10px;"><canvas id="chart-trend"></canvas></div>
      </div>
      <div class="card pad" style="background:rgba(255,255,255,.03); border-radius:14px;">
        <b>Top operators</b>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
          <div style="height:260px;">
            <div class="muted" style="font-size:12px; margin-bottom:6px;">Packed IDs</div>
            <div style="height:230px;"><canvas id="chart-ops-ids"></canvas></div>
          </div>
          <div style="height:260px;">
            <div class="muted" style="font-size:12px; margin-bottom:6px;">Packed items</div>
            <div style="height:230px;"><canvas id="chart-ops-items"></canvas></div>
          </div>
          <div style="height:260px;">
            <div class="muted" style="font-size:12px; margin-bottom:6px;">Return IDs</div>
            <div style="height:230px;"><canvas id="chart-ret-ops-ids"></canvas></div>
          </div>
          <div style="height:260px;">
            <div class="muted" style="font-size:12px; margin-bottom:6px;">Returned items</div>
            <div style="height:230px;"><canvas id="chart-ret-ops-items"></canvas></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="tab-perf" class="card pad" style="margin-top:14px;">
    <h3 style="margin:0 0 10px 0;">üë• Performance by operator</h3>
    <div class="scroll">
      <table id="tbl-perf">
        <thead>
          <tr>
            <th>Operator</th>
            <th>Packed IDs</th>
            <th>Packed Items</th>
            <th>Returns IDs</th>
            <th>Returned Items</th>
            <th>Pre-pack Scans</th>
            <th>Avg. pack time</th>
            <th>Avg. return time</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="tab-pick" class="card pad hide" style="margin-top:14px;">
    <h3 style="margin:0 0 10px 0;">üß∫ Picking by operator</h3>
    <div class="muted" style="font-size:12px; margin:0 0 10px 0;">
      Based on <code>active_batches</code> records with <code>pickedBy</code>/<code>picked_by</code>.
      IDs = expected IDs excluding cancelled; Products = inventory qty sum excluding WARRANTY ES/PT.
    </div>
    <div class="scroll">
      <table id="tbl-pick">
        <thead>
          <tr>
            <th>Operator</th>
            <th>Batches picked</th>
            <th>Picked IDs</th>
            <th>Picked products</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="tab-sold" class="card pad hide" style="margin-top:14px;">
    <h3 style="margin:0 0 10px 0;">üî• Top-selling products (PACKING)</h3>
    <div style="height:320px; margin-top:8px;"><canvas id="chart-sold"></canvas></div>
    <div class="scroll">
      <table id="tbl-sold">
        <thead><tr><th>#</th><th>Produto</th><th>Qtd</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="tab-ret" class="card pad hide" style="margin-top:14px;">
    <h3 style="margin:0 0 10px 0;">‚Ü©Ô∏è Most-returned products (RETURN/RETURNS)</h3>
    <div style="height:320px; margin-top:8px;"><canvas id="chart-ret"></canvas></div>
    <div class="scroll">
      <table id="tbl-ret">
        <thead><tr><th>#</th><th>Produto</th><th>Qtd</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="tab-ratio" class="card pad hide" style="margin-top:14px;">
    <h3 style="margin:0 0 10px 0;">üìâ Return rate by product</h3>
    <div style="height:320px; margin-top:8px;"><canvas id="chart-ratio"></canvas></div>
    <p class="muted" style="margin-top:0;">Rate = returns / sold (within the range). Only products with at least 10 sales are shown.</p>
    <div class="scroll">
      <table id="tbl-ratio">
        <thead><tr><th>#</th><th>Produto</th><th>Vendidos</th><th>Returns</th><th>Taxa</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>



  <div id="tab-carriers" class="card pad hide" style="margin-top:14px;">
    <h3 style="margin:0 0 10px 0;">üöö Carrier analysis (Printed IDs)</h3>
    <div style="height:320px; margin-top:8px;"><canvas id="chart-carrier-printed"></canvas></div>
    <p class="muted" style="margin-top:0;">Printed IDs are calculated from <code>active_batches</code> as the number of required IDs (expected IDs minus cancelled IDs) within the selected date range, grouped by carrier. Percentages are shown within each country group (PT vs ES) + the carrier share of the overall total.</p>
    <div class="scroll">
      <table id="tbl-carriers">
        <thead><tr><th>Country</th><th>Carrier</th><th>Printed IDs</th><th>Cancelled IDs</th><th>Printed % (country)</th><th>Country % (total)</th><th>Batches</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>



  <div id="tab-opprods" class="card pad hide" style="margin-top:14px;">
    <h3 style="margin:0 0 10px 0;">üì¶ Products packed by operator (PACKING)</h3>

    <div class="grid grid-3" style="margin-bottom:10px;">
      <div>
        <label>Operator</label>
        <select id="sel-opprods" onchange="renderOperatorProducts()"></select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn secondary" onclick="exportCSV('opproducts')">Export CSV (operator√óproduct)</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <span class="muted" style="font-size:12px;">Counts items inside PACKING (excluding WARRANTY products).</span>
      </div>
    </div>

    <div class="scroll">
      <table id="tbl-opprods">
        <thead><tr><th>#</th><th>Product</th><th>Qty</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>


    <div id="tab-oprets" class="card pad hide" style="margin-top:14px;">
    <h3 style="margin:0 0 10px 0;">‚Ü©Ô∏è Returns by operator (RETURN/RETURNS)</h3>

    <!-- Same operator‚Üíproducts view as PACKING (Products by operator) -->
    <div class="grid grid-3" style="margin-bottom:10px;">
      <div>
        <label>Operator</label>
        <select id="sel-oprets" onchange="renderOperatorReturns()"></select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn secondary" onclick="exportCSV('opreturns_products')">Export CSV (operator√óreturned product)</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <span class="muted" style="font-size:12px;">Counts items inside RETURN/RETURNS (excluding WARRANTY products).</span>
      </div>
    </div>

    <div class="card pad" style="background:rgba(255,255,255,.03); border-radius:14px;">
      <b>Returned products (qty)</b>
      <div style="height:240px; margin-top:10px;"><canvas id="chart-oprets-prods"></canvas></div>
      <div class="scroll" style="margin-top:10px;">
        <table id="tbl-oprets-prods">
          <thead><tr><th>#</th><th>Product</th><th>Qty</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Optional: keep IDs view available, but tucked away so the main view matches PACKING -->
    <details style="margin-top:12px;">
      <summary class="muted" style="cursor:pointer; font-weight:650;">Show returned IDs (items)</summary>

      <div class="grid grid-3" style="margin-top:10px; margin-bottom:10px;">
        <div></div>
        <div></div>
        <div>
          <button class="btn secondary" onclick="exportCSV('opreturns_ids')">Export CSV (operator√óreturned id)</button>
        </div>
      </div>

      <div class="card pad" style="background:rgba(255,255,255,.03); border-radius:14px;">
        <b>Returned IDs (items)</b>
        <div class="muted" style="font-size:12px; margin-top:6px;">Items = number of non-WARRANTY products in RETURN/RETURNS for the ID.</div>
        <div style="height:240px; margin-top:10px;"><canvas id="chart-oprets-ids"></canvas></div>
        <div class="scroll" style="margin-top:10px;">
          <table id="tbl-oprets-ids">
            <thead><tr><th>#</th><th>ID</th><th>Items</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </details>
  </div>

  <div id="tab-daycar" class="card pad hide" style="margin-top:14px;">
    <h3 style="margin:0 0 10px 0;">üóìÔ∏è Products created in batch (IDs) by day & carrier</h3>

    <div class="grid grid-3" style="margin-bottom:10px;">
      <div>
        <label>Day</label>
        <select id="sel-daycar-day" onchange="onDayCarrierDayChange()"></select>
      </div>
      <div>
        <label>Carrier</label>
        <select id="sel-daycar-carrier" onchange="renderDayCarrierProducts()"></select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn secondary" onclick="exportCSV('daycarrier')">Export CSV (day√ócarrier√óproduct)</button>
      </div>
    </div>

    <div class="muted" style="font-size:12px; margin-bottom:10px;">
      Built from <code>active_batches</code> (expected IDs minus cancelled IDs) joined with <code>registos</code> PACKING by <code>id</code>.
      Products exclude WARRANTY.
    </div>

    <div class="scroll">
      <table id="tbl-daycar">
        <thead><tr><th>#</th><th>Product</th><th>Qty</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  
  <div id="tab-offinv" class="card pad hide" style="margin-top:14px;">
    <h3 style="margin:0 0 10px 0;">üìã OFF ‚Ä¢ Produtos/Quantidades colados em lotes (por transportadora)</h3>

    <div class="grid grid-3" style="margin-bottom:10px;">
      <div>
        <label>Carrier</label>
        <select id="sel-offinv-carrier" onchange="renderOffInvDetail()"></select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn secondary" onclick="exportCSV('offinv')">Export CSV (carrier√óSKU)</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <span class="muted" style="font-size:12px;">Fonte: <code>active_batches.inventory</code> (o que foi colado no OFFICE &gt; Create New Batch).</span>
      </div>
    </div>

    <div class="grid grid-2" style="gap:12px;">
      <div class="card pad" style="background:rgba(255,255,255,.03); border-radius:14px;">
        <b>Resumo por transportadora</b>
        <div class="scroll" style="margin-top:10px;">
          <table id="tbl-offinv-carriers">
            <thead><tr><th>Carrier</th><th>Batches</th><th>SKUs</th><th>Total Qty</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card pad" style="background:rgba(255,255,255,.03); border-radius:14px;">
        <b>Detalhe (SKU ‚Üí Qty)</b>
        <div class="scroll" style="margin-top:10px;">
          <table id="tbl-offinv">
            <thead><tr><th>#</th><th>SKU</th><th>Qty</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<div id="tab-export" class="card pad hide" style="margin-top:14px;">
    <h3 style="margin:0 0 10px 0;">üìÅ Export</h3>
    <div class="grid grid-2">
      <div class="card pad" style="background:rgba(255,255,255,.03); border-radius:14px;">
        <b>Export (CSV)</b>
        <p class="muted" style="margin:8px 0 12px 0;">Export tables (performance + top lists) to CSV.</p>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn secondary" onclick="exportCSV('performance')">Performance</button>
          <button class="btn secondary" onclick="exportCSV('sold')">Top sold</button>
          <button class="btn secondary" onclick="exportCSV('returns')">Top returns</button>
          <button class="btn secondary" onclick="exportCSV('ratio')">Return rate</button>
          <button class="btn secondary" onclick="exportCSV('carriers')">Carriers (printed)</button>
          <button class="btn secondary" onclick="exportCSV('opproducts')">Products by operator</button>
          <button class="btn secondary" onclick="exportCSV('opreturns_products')">Returns by operator (products)</button>
          <button class="btn secondary" onclick="exportCSV('opreturns_ids')">Returns by operator (IDs)</button>
          <button class="btn secondary" onclick="exportCSV('daycarrier')">Products by day & carrier</button>
          <button class="btn secondary" onclick="exportCSV('offinv')">OFF batches (SKU/QTY)</button>
        </div>
      </div>
      <div class="card pad" style="background:rgba(255,255,255,.03); border-radius:14px;">
        <b>Notes</b>
        <ul class="muted" style="margin:8px 0 0 18px; line-height:1.55;">
          <li>PACKING and RETURNS come from <code>registos</code> (with <code>dateClean</code>, <code>user</code>, <code>prods</code>, <code>startTime</code>/<code>endTime</code>).</li>
          <li>Pre-pack comes from <code>pre_packing</code> (each record = 1 product scan).</li>
          <li>For large ranges, the dashboard runs one query per day (more stable than scanning the entire DB).</li>
        </ul>
      </div>
    </div>
  </div>

</div>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  // Firebase config copied from the current panel
  const firebaseConfig = {
    apiKey: "AIzaSyDExvgmtrSILCATQgE8ICJX-SVntb5lM2Y",
    authDomain: "wh-murtede.firebaseapp.com",
    databaseURL: "https://wh-murtede-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "wh-murtede",
    storageBucket: "wh-murtede.firebasestorage.app",
    messagingSenderId: "415946575714",
    appId: "1:415946575714:web:b1516b91b9735b9248e63b"
  };

  let auth = null, db = null, currentUser = null;

  // caches para export
  let __last = {
    range: {start:"", end:""},
    perfRows: [],
    pickRows: [],
    soldRows: [],
    retRows: [],
    ratioRows: [],
    carrierRows: [],
    opProductsMap: {},
    opReturnsProductsMap: {},
    opReturnsIdsMap: {},
    dayCarrierProdMap: {},
    totals: {}
  };

  function _nowISO(){ return new Date().toISOString().slice(0,10); }
  function _fmt(x){ return (x===undefined||x===null) ? "" : String(x); }
function _u(x){ return _fmt(x).trim().toUpperCase(); }

// Products to ignore in item counts / product rankings
const EXCLUDED_PRODUCTS = new Set(["WARRANTY ES", "WARRANTY PT"]);
function _isExcludedProduct(p){
  const u = _u(p);
  // Allow variants like 'WARRANTY ES x1'
  if(u === "WARRANTY ES" || u.startsWith("WARRANTY ES ")) return true;
  if(u === "WARRANTY PT" || u.startsWith("WARRANTY PT ")) return true;
  return EXCLUDED_PRODUCTS.has(u);
}

function _dtKey(dc, tm){
    if(!dc) return "";
    if(!tm) tm = "00:00:00";
    tm = String(tm).trim();
    if(tm.length === 5) tm += ":00";
    return dc + " " + tm;
  }

  function _parseTimeToSec(tm){
    tm = (tm||"").toString().trim();
    if(!tm) return null;
    // allow HH:MM or HH:MM:SS
    const parts = tm.split(':').map(n => parseInt(n,10));
    if(parts.length < 2 || parts.some(n => Number.isNaN(n))) return null;
    const h = parts[0]||0, m = parts[1]||0, s = parts[2]||0;
    return h*3600 + m*60 + s;
  }

  function _countProducts(prodsStr){
    return _splitProducts(prodsStr).length;
  }

  function _splitProducts(prodsStr){
    const s = (prodsStr||"").toString().trim();
    if(!s || s.toUpperCase()==='NO ITEMS') return [];
    return s
      .split('|')
      .map(x=>x.trim())
      .filter(Boolean)
      .filter(p => !_isExcludedProduct(p));
  }

  function _requiredBatchIds(batch){
    const expected = (batch && Array.isArray(batch.expected_ids)) ? batch.expected_ids : [];
    const cancelled = (batch && batch.cancelled_ids) ? Object.keys(batch.cancelled_ids) : [];
    const cset = new Set(cancelled);
    return expected.filter(id => !cset.has(id));
  }

  function _carrierName(batch){
    const c = (batch && (batch.carrier_override || batch.carrier)) ? (batch.carrier_override || batch.carrier) : 'UNKNOWN';
    return _u(c) || 'UNKNOWN';
  }


  // Carrier groups by country
  const CARRIERS_ES = new Set(['NACEX', 'CORREOS ES']);
  const CARRIERS_PT = new Set(['CTT', 'CTT ILHAS', 'CORREOS PT', 'VASP']);

  function _carrierCountry(carrier){
    const c = _u(carrier);
    if(CARRIERS_ES.has(c)) return 'ES';
    if(CARRIERS_PT.has(c)) return 'PT';
    return 'OTHER';
  }


  function _dateListInclusive(startISO, endISO){
    const out=[];
    const s=new Date(startISO+"T00:00:00");
    const e=new Date(endISO+"T00:00:00");
    if(Number.isNaN(s.getTime())||Number.isNaN(e.getTime())) return out;
    for(let d=new Date(s); d<=e; d.setDate(d.getDate()+1)){
      out.push(d.toISOString().slice(0,10));
    }
    return out;
  }

  function showTab(key){
    document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===key));
    ['perf','pick','sold','ret','ratio','carriers','opprods','oprets','daycar','offinv','export'].forEach(k=>{
      document.getElementById('tab-'+k).classList.toggle('hide', k!==key);
    });
  }
  window.showTab = showTab;

  function _setStatus(s){ document.getElementById('status').innerText = s || ""; }

  async function handleLogin(){
    const em = document.getElementById('email').value.trim();
    const pw = document.getElementById('pass').value;
    const msg = document.getElementById('login-msg');
    msg.innerText = "";

    try{
      if(!auth) throw new Error('Firebase not ready');
      await auth.signInWithEmailAndPassword(em, pw);
    }catch(e){
      console.error(e);
      msg.innerText = "Login error: " + (e && e.message ? e.message : e);
    }
  }
  window.handleLogin = handleLogin;

  function _kpi(title, value, hint){
    return `<div class="kpi"><div class="t">${title}</div><div class="v">${value}</div><div class="t" style="margin-top:6px;">${hint||""}</div></div>`;
  }

  function _renderKPIs(t){
    const el = document.getElementById('kpis');
    el.innerHTML = [
      _kpi('Packed IDs', t.packedIds||0, 'PACKING records'),
      _kpi('Packed Items', t.packedProducts||0, 'Items in PACKING'),
      _kpi('Returns IDs', t.returnIds||0, 'RETURN/RETURNS records'),
      _kpi('Pre-pack Scans', t.prepackScans||0, 'pre_packing records'),
      _kpi('Printed IDs', t.printedIds||0, 'From active_batches'),
      _kpi('OFF Items', t.offInvItems||0, 'Sum of active_batches.inventory (excluding WARRANTY)'),
      _kpi('OFF SKUs', t.offInvSkus||0, 'Unique SKUs in active_batches.inventory (excluding WARRANTY)'),
      _kpi('Cancelled IDs', t.cancelledIds||0, 'From active_batches'),
      _kpi('PT %', (t.ptPrintedPct!=null ? (t.ptPrintedPct*100).toFixed(1)+'%' : '-'), 'Share of Printed IDs (PT carriers)'),
      _kpi('ES %', (t.esPrintedPct!=null ? (t.esPrintedPct*100).toFixed(1)+'%' : '-'), 'Share of Printed IDs (ES carriers)')
    ].join('');
  }

  function _renderPerfRows(rows){
    const tb = document.querySelector('#tbl-perf tbody');
    tb.innerHTML = rows.map(r=>{
      const avgPack = (r.avgPackSec!=null) ? `${Math.round(r.avgPackSec)}s` : '-';
      const avgRet  = (r.avgReturnSec!=null) ? `${Math.round(r.avgReturnSec)}s` : '-';
      return `<tr>
        <td><b>${_fmt(r.user)}</b></td>
        <td>${r.packedIds}</td>
        <td>${r.packedProducts}</td>
        <td>${r.returnIds}</td>
        <td>${r.returnProducts}</td>
        <td>${r.prepackScans}</td>
        <td>${avgPack}</td>
        <td>${avgRet}</td>
      </tr>`;
    }).join('');
  }

  
  function _renderPickRows(rows){
    const tb = document.querySelector('#tbl-pick tbody');
    if(!tb) return;
    tb.innerHTML = rows.map(r=>{
      return `<tr>
        <td><b>${_fmt(r.user)}</b></td>
        <td>${r.pickedBatches}</td>
        <td>${r.pickedIds}</td>
        <td>${r.pickedProducts}</td>
      </tr>`;
    }).join('');
  }

function _renderTopTable(tbodySel, rows){
    const tb = document.querySelector(tbodySel);
    tb.innerHTML = rows.map((r,i)=>`<tr><td>${i+1}</td><td><b>${_fmt(r.product)}</b></td><td>${r.qty}</td></tr>`).join('');
  }
  function _renderRatio(rows){
    const tb = document.querySelector('#tbl-ratio tbody');
    tb.innerHTML = rows.map((r,i)=>{
      const pct = (r.rate*100);
      const cls = pct >= 10 ? 'warn' : 'good';
      return `<tr>
        <td>${i+1}</td>
        <td><b>${_fmt(r.product)}</b></td>
        <td>${r.sold}</td>
        <td>${r.returns}</td>
        <td><span class="pill ${cls}">${pct.toFixed(1)}%</span></td>
      </tr>`;
    }).join('');
  }

  function _renderCarriers(rows){
    const tb = document.querySelector('#tbl-carriers tbody');
    if(!tb) return;
    tb.innerHTML = (rows||[]).map(r=>{
      const pctCountry = (r.printedPct!=null) ? (r.printedPct*100) : 0;
      const pctTotal = (r.countrySharePct!=null) ? (r.countrySharePct*100) : 0;
      const cls = pctCountry >= 40 ? 'good' : (pctCountry >= 20 ? 'warn' : '');
      return `<tr>
        <td><b>${_fmt(r.country||'')}</b></td>
        <td><b>${_fmt(r.carrier)}</b></td>
        <td>${r.printedIds}</td>
        <td>${r.cancelledIds||0}</td>
        <td>${cls ? `<span class="pill ${cls}">${pctCountry.toFixed(1)}%</span>` : pctCountry.toFixed(1)+'%'}</td>
        <td>${pctTotal.toFixed(1)}%</td>
        <td>${r.batches}</td>
      </tr>`;
    }).join('');
  }

  // -------- Products packed by operator (PACKING) --------
  function _initOperatorProducts(perfRows, packedUserProdMap){
    const sel = document.getElementById('sel-opprods');
    if(!sel) return;

    const ops = (perfRows||[]).map(r=>r.user);
    sel.innerHTML = ops.map(u=>`<option value="${u}">${u}</option>`).join('');
    if(ops.length) sel.value = ops[0];

    window.__packedUserProdMap = packedUserProdMap || {};
    renderOperatorProducts();
  }

  function renderOperatorProducts(){
    const sel = document.getElementById('sel-opprods');
    const tb = document.querySelector('#tbl-opprods tbody');
    if(!sel || !tb) return;

    const u = sel.value;
    const mp = (window.__packedUserProdMap && window.__packedUserProdMap[u]) ? window.__packedUserProdMap[u] : {};

    const rows = Object.entries(mp)
      .map(([product,qty])=>({product, qty}))
      .sort((a,b)=> b.qty - a.qty)
      .slice(0, 200);

    tb.innerHTML = rows.map((r,i)=>
      `<tr><td>${i+1}</td><td><b>${_fmt(r.product)}</b></td><td>${r.qty}</td></tr>`
    ).join('');
  }

  // -------- Returns by operator (RETURN/RETURNS): products + IDs --------
  function _initOperatorReturns(perfRows, returnsUserProdMap, returnsUserIdMap){
    const sel = document.getElementById('sel-oprets');
    if(!sel) return;

    // Build a stable operator list: union of perf users + users that appear in returns
    const opsSet = new Set();
    (perfRows||[]).forEach(r=> opsSet.add(r.user));
    Object.keys(returnsUserProdMap||{}).forEach(u=> opsSet.add(u));
    Object.keys(returnsUserIdMap||{}).forEach(u=> opsSet.add(u));

    const ops = Array.from(opsSet).filter(Boolean).sort((a,b)=> a.localeCompare(b));
    sel.innerHTML = ops.map(u=>`<option value="${u}">${u}</option>`).join('');
    sel.value = ops.length ? ops[0] : '';

    window.__returnsUserProdMap = returnsUserProdMap || {};
    window.__returnsUserIdMap = returnsUserIdMap || {};
    renderOperatorReturns();
  }

  function renderOperatorReturns(){
    const sel = document.getElementById('sel-oprets');
    const tbProds = document.querySelector('#tbl-oprets-prods tbody');
    const tbIds = document.querySelector('#tbl-oprets-ids tbody');
    if(!sel || !tbProds || !tbIds) return;

    const u = sel.value;

    // Products
    const mp = (window.__returnsUserProdMap && window.__returnsUserProdMap[u]) ? window.__returnsUserProdMap[u] : {};
    const prodRows = Object.entries(mp)
      .map(([product,qty])=>({product, qty}))
      .sort((a,b)=> b.qty - a.qty)
      .slice(0, 300);

    tbProds.innerHTML = prodRows.length
      ? prodRows.map((r,i)=> `<tr><td>${i+1}</td><td><b>${_fmt(r.product)}</b></td><td>${r.qty}</td></tr>`).join('')
      : `<tr><td colspan="3" class="muted">No RETURN/RETURNS products for this operator in the selected range.</td></tr>`;

    // IDs
    const idMap = (window.__returnsUserIdMap && window.__returnsUserIdMap[u]) ? window.__returnsUserIdMap[u] : {};
    const idRows = Object.entries(idMap)
      .map(([id,items])=>({id, items}))
      .sort((a,b)=> (b.items - a.items) || a.id.localeCompare(b.id))
      .slice(0, 500);

    tbIds.innerHTML = idRows.length
      ? idRows.map((r,i)=> `<tr><td>${i+1}</td><td><b>${_fmt(r.id)}</b></td><td>${r.items}</td></tr>`).join('')
      : `<tr><td colspan="3" class="muted">No RETURN/RETURNS IDs for this operator in the selected range.</td></tr>`;

    _renderOperatorReturnsCharts(prodRows, idRows);
  }
  window.renderOperatorReturns = renderOperatorReturns;


  function _renderOperatorReturnsCharts(prodRows, idRows){
    if(typeof Chart === 'undefined') return;

    // Returned products chart
    const topProds = (prodRows||[]).slice(0, 15);
    _destroyChart('opRetProds');
    if(document.getElementById('chart-oprets-prods')){
      __charts.opRetProds = _mkBarChart(
        'chart-oprets-prods',
        topProds.map(r=>r.product),
        topProds.map(r=>r.qty),
        'Returned products'
      );
    }

    // Returned IDs chart (items)
    const topIds = (idRows||[]).slice(0, 15);
    _destroyChart('opRetIds');
    if(document.getElementById('chart-oprets-ids')){
      __charts.opRetIds = _mkBarChart(
        'chart-oprets-ids',
        topIds.map(r=>r.id),
        topIds.map(r=>r.items),
        'Returned items (by ID)'
      );
    }
  }

  window.renderOperatorProducts = renderOperatorProducts;


  // -------- Products by day & carrier (from batches -> IDs -> PACKING products) --------
  function _initDayCarrier(dayList, dayCarrierProdMap){
    const selDay = document.getElementById('sel-daycar-day');
    const selCarrier = document.getElementById('sel-daycar-carrier');
    if(!selDay || !selCarrier) return;

    window.__dayCarrierProdMap = dayCarrierProdMap || {};

    // Prefer showing only days that actually have at least 1 carrier in the map
    const daysWithData = (dayList||[]).filter(d=>{
      const mp = window.__dayCarrierProdMap[d];
      return mp && Object.keys(mp).length > 0;
    });
    const finalDays = daysWithData.length ? daysWithData : (dayList||[]);
    window.__dayCarrierDays = finalDays.slice();

    selDay.innerHTML = finalDays.map(d=>`<option value="${d}">${d}</option>`).join('');
    selDay.value = finalDays.length ? finalDays[0] : '';

    onDayCarrierDayChange();
  }

  function onDayCarrierDayChange(){
    const selDay = document.getElementById('sel-daycar-day');
    const selCarrier = document.getElementById('sel-daycar-carrier');
    if(!selDay || !selCarrier) return;

    const d = selDay.value;
    const mp = (window.__dayCarrierProdMap && window.__dayCarrierProdMap[d]) ? window.__dayCarrierProdMap[d] : {};
    const carriers = Object.keys(mp).sort();

    if(!carriers.length){
      selCarrier.innerHTML = `<option value="">(no carriers)</option>`;
      selCarrier.value = '';
      renderDayCarrierProducts();
      return;
    }

    selCarrier.innerHTML = carriers.map(c=>`<option value="${c}">${c}</option>`).join('');
    selCarrier.value = carriers[0];

    renderDayCarrierProducts();
  }
  window.onDayCarrierDayChange = onDayCarrierDayChange;

  function renderDayCarrierProducts(){
    const selDay = document.getElementById('sel-daycar-day');
    const selCarrier = document.getElementById('sel-daycar-carrier');
    const tb = document.querySelector('#tbl-daycar tbody');
    if(!selDay || !selCarrier || !tb) return;

    const d = selDay.value;
    const c = selCarrier.value;

    if(!d || !c){
      tb.innerHTML = `<tr><td colspan="3" class="muted">No data for the selected day.</td></tr>`;
      return;
    }

    const bucket = (window.__dayCarrierProdMap && window.__dayCarrierProdMap[d] && window.__dayCarrierProdMap[d][c])
      ? window.__dayCarrierProdMap[d][c]
      : {prodMap:{}, collectedIds:0, collectedItems:0};

    const rows = Object.entries(bucket.prodMap || {})
      .map(([product,qty])=>({product, qty}))
      .sort((a,b)=> b.qty - a.qty)
      .slice(0, 200);

    if(!rows.length){
      tb.innerHTML = `<tr><td colspan="3" class="muted">No products found. (Tip: this depends on matching batch expected_ids with PACKING registos.id)</td></tr>`;
      return;
    }

    tb.innerHTML = rows.map((r,i)=>
      `<tr><td>${i+1}</td><td><b>${_fmt(r.product)}</b></td><td>${r.qty}</td></tr>`
    ).join('');
  }
  window.renderDayCarrierProducts = renderDayCarrierProducts;




  // -------- OFF batches inventory (SKU/QTY pasted in OFFICE) by carrier --------
  function _initOffInventory(carrierInvMap){
    const sel = document.getElementById('sel-offinv-carrier');
    if(!sel) return;

    window.__offInvMap = carrierInvMap || {};

    const carriers = Object.keys(window.__offInvMap).sort();
    sel.innerHTML = carriers.length
      ? carriers.map(c=>`<option value="${c}">${c}</option>`).join('')
      : `<option value="">(no data)</option>`;

    sel.value = carriers.length ? carriers[0] : '';

    _renderOffInvSummary();
    renderOffInvDetail();
  }
  window._initOffInventory = _initOffInventory;

  function _renderOffInvSummary(){
    const tb = document.querySelector('#tbl-offinv-carriers tbody');
    if(!tb) return;

    const mp = window.__offInvMap || {};
    const rows = Object.keys(mp).map(c=>{
      const o = mp[c] || {batches:0,totalQty:0,skuMap:{}};
      return {
        carrier: c,
        batches: o.batches||0,
        skuCount: Object.keys(o.skuMap||{}).length,
        totalQty: o.totalQty||0
      };
    }).sort((a,b)=> (b.totalQty - a.totalQty) || a.carrier.localeCompare(b.carrier));

    if(!rows.length){
      tb.innerHTML = `<tr><td colspan="4" class="muted">No batches/inventory found in this date range.</td></tr>`;
      return;
    }

    tb.innerHTML = rows.map(r=>
      `<tr><td><b>${_fmt(r.carrier)}</b></td><td>${r.batches}</td><td>${r.skuCount}</td><td>${r.totalQty}</td></tr>`
    ).join('');
  }

  function renderOffInvDetail(){
    const sel = document.getElementById('sel-offinv-carrier');
    const tb = document.querySelector('#tbl-offinv tbody');
    if(!sel || !tb) return;

    const c = sel.value;
    const mp = window.__offInvMap || {};
    const o = (c && mp[c]) ? mp[c] : {skuMap:{}};

    const rows = Object.entries(o.skuMap||{})
      .map(([sku,qty])=>({sku, qty}))
      .sort((a,b)=> (b.qty - a.qty) || a.sku.localeCompare(b.sku))
      .slice(0, 500);

    if(!rows.length){
      tb.innerHTML = `<tr><td colspan="3" class="muted">No SKUs for the selected carrier.</td></tr>`;
      return;
    }

    tb.innerHTML = rows.map((r,i)=>
      `<tr><td>${i+1}</td><td><b>${_fmt(r.sku)}</b></td><td>${r.qty}</td></tr>`
    ).join('');
  }
  window.renderOffInvDetail = renderOffInvDetail;



  async function _loadDay(dateClean){
    // Mesma estrat√©gia do OFF: query por dateClean para evitar varrer a DB toda
    const [regSnap, ppSnap] = await Promise.all([
      db.ref('registos').orderByChild('dateClean').equalTo(dateClean).once('value'),
      db.ref('pre_packing').orderByChild('dateClean').equalTo(dateClean).once('value')
    ]);

    const regObj = regSnap.val() || {};
    const ppObj  = ppSnap.val() || {};

    const regList = Object.values(regObj).filter(Boolean);
    const ppList  = Object.values(ppObj).filter(Boolean);

    return {regList, ppList};
  }

  async function runAnalytics(){
    const s = document.getElementById('start').value;
    const e = document.getElementById('end').value;
    if(!s || !e) return alert('Select a date range.');
    if(s > e) return alert('Start date must be <= End date.');

    _setStatus('Loading‚Ä¶');

    const days = _dateListInclusive(s,e);
    const allReg = [];
    const allPP = [];

    // Load day-by-day (safer). Could be parallel but we keep sequential to avoid rate limits.
    for(let i=0;i<days.length;i++){
      _setStatus(`Loading ${i+1}/${days.length} (${days[i]})‚Ä¶`);
      const d = await _loadDay(days[i]);
      allReg.push(...d.regList);
      allPP.push(...d.ppList);
    }

    // normalize modes
    const reg = allReg.map(r=>{
      const mode = _u(r.mode || r.Type || '');
      return {
        user: _u(r.user || 'UNKNOWN'),
        mode,
        id: _fmt(r.id||'').trim(),
        prods: _fmt(r.prods||''),
        startTime: r.startTime || '',
        endTime: r.endTime || '',
        startTs: (typeof r.startTs === 'number') ? r.startTs : null,
        endTs: (typeof r.endTs === 'number') ? r.endTs : null,
        dateClean: r.dateClean || '',
        batch: r.batch || 'GENERAL'
      };
    });

    const pp = allPP.map(p=>({
      user: _u(p.user || p.operator || 'UNKNOWN'),
      product: _fmt(p.product||p.code||'').trim(),
      dateClean: p.dateClean || ''
    }));

    const packed = reg.filter(x=>x.mode==='PACKING');
    const returns = reg.filter(x=>x.mode==='RETURN' || x.mode==='RETURNS');

    // products packed per operator (user -> {product: qty})
    const packedUserProdMap = {};
    packed.forEach(x=>{
      const u = x.user || 'UNKNOWN';
      if(!packedUserProdMap[u]) packedUserProdMap[u] = {};
      _splitProducts(x.prods).forEach(p=>{
        packedUserProdMap[u][p] = (packedUserProdMap[u][p] || 0) + 1;
      });
    });


    // returns by operator: products + IDs (RETURN/RETURNS)
    const returnsUserProdMap = {}; // user -> {product: qty}
    const returnsUserIdMap = {};   // user -> {id: items}
    returns.forEach(x=>{
      const u = x.user || 'UNKNOWN';
      if(!returnsUserProdMap[u]) returnsUserProdMap[u] = {};
      if(!returnsUserIdMap[u]) returnsUserIdMap[u] = {};

      // products (excluding WARRANTY)
      _splitProducts(x.prods).forEach(p=>{
        returnsUserProdMap[u][p] = (returnsUserProdMap[u][p] || 0) + 1;
      });

      // IDs: sum items (excluding WARRANTY) per ID
      const keyId = String(x.id||'').trim();
      if(keyId){
        returnsUserIdMap[u][keyId] = (returnsUserIdMap[u][keyId] || 0) + _countProducts(x.prods);
      }
    });

    // id -> products (from PACKING)
    // NOTE: expected_ids in batches can be numbers/strings; we normalize keys to trimmed strings.
    // If the same ID appears multiple times in PACKING, we MERGE products (keeps correct item counts).
    const packedById = {};
    packed.forEach(x=>{
      const key = String(x.id||'').trim();
          if(!key) return;
      const prods = _splitProducts(x.prods);
      if(!packedById[key]) packedById[key] = [];
      packedById[key].push(...prods);
    });



    // totals
    const totals = {
      packedIds: packed.length,
      returnIds: returns.length,
      packedProducts: packed.reduce((a,x)=>a+_countProducts(x.prods),0),
      returnProducts: returns.reduce((a,x)=>a+_countProducts(x.prods),0),
      prepackScans: pp.length
    };

    // performance per user
    const byU = {};
    function ensure(u){
      if(!byU[u]) byU[u] = {user:u, packedIds:0, packedProducts:0, returnIds:0, returnProducts:0, prepackScans:0, packSecSum:0, packSecN:0, returnSecSum:0, returnSecN:0};
      return byU[u];
    }

    packed.forEach(x=>{
      const r = ensure(x.user);
      r.packedIds++;
      r.packedProducts += _countProducts(x.prods);

      let dt = null;

      // Prefer numeric timestamps when available (milliseconds since epoch)
      if(Number.isFinite(x.startTs) && Number.isFinite(x.endTs)){
        dt = (x.endTs - x.startTs) / 1000;
      } else {
        // Fallback to HH:MM(:SS) strings
        const st = _parseTimeToSec(x.startTime);
        const et = _parseTimeToSec(x.endTime);
        if(st!=null && et!=null){
          dt = et - st;
          if(dt < 0) dt += 24*3600; // rollover safe
        }
      }

      if(dt!=null && dt>=0 && dt<= 4*3600){ // guard: ignore insane durations
        r.packSecSum += dt;
        r.packSecN += 1;
      }
    });

    returns.forEach(x=>{
      const r = ensure(x.user);
      r.returnIds++;
      r.returnProducts += _countProducts(x.prods);

      let dt = null;

      // Prefer numeric timestamps when available (milliseconds since epoch)
      if(Number.isFinite(x.startTs) && Number.isFinite(x.endTs)){
        dt = (x.endTs - x.startTs) / 1000;
      } else {
        // Fallback to HH:MM(:SS) strings
        const st = _parseTimeToSec(x.startTime);
        const et = _parseTimeToSec(x.endTime);
        if(st!=null && et!=null){
          dt = et - st;
          if(dt < 0) dt += 24*3600; // rollover safe
        }
      }

      if(dt!=null && dt>=0 && dt<= 4*3600){ // guard: ignore insane durations
        r.returnSecSum += dt;
        r.returnSecN += 1;
      }

    });

    pp.forEach(x=>{
      ensure(x.user).prepackScans++;
    });

    const perfRows = Object.values(byU)
      .map(r=>({
        ...r,
        avgPackSec: r.packSecN ? (r.packSecSum / r.packSecN) : null,
        avgReturnSec: r.returnSecN ? (r.returnSecSum / r.returnSecN) : null
      }))
      .sort((a,b)=> (b.packedIds - a.packedIds) || a.user.localeCompare(b.user));


    // init products-by-operator tab
    _initOperatorProducts(perfRows, packedUserProdMap);

    // init returns-by-operator tab
    _initOperatorReturns(perfRows, returnsUserProdMap, returnsUserIdMap);

    // top sold products
    const soldMap = {};
    packed.forEach(x=>{
      _splitProducts(x.prods).forEach(p=>{ soldMap[p] = (soldMap[p]||0) + 1; });
    });
    const soldRows = Object.entries(soldMap)
      .map(([product,qty])=>({product,qty}))
      .sort((a,b)=>b.qty-a.qty)
      .slice(0,200);

    // top return products
    const retMap = {};
    returns.forEach(x=>{
      _splitProducts(x.prods).forEach(p=>{ retMap[p] = (retMap[p]||0) + 1; });
    });
    const retRows = Object.entries(retMap)
      .map(([product,qty])=>({product,qty}))
      .sort((a,b)=>b.qty-a.qty)
      .slice(0,200);

    // return rate
    const ratioRows = [];
    Object.keys(soldMap).forEach(prod=>{
      const sold = soldMap[prod]||0;
      const ret = retMap[prod]||0;
      if(sold >= 10){
        ratioRows.push({product:prod, sold, returns:ret, rate: sold ? (ret/sold) : 0});
      }
    });
    ratioRows.sort((a,b)=> (b.rate - a.rate) || (b.returns - a.returns) || (b.sold - a.sold));

    // carriers / printed IDs (from active_batches)
    _setStatus('Loading batches (active_batches)‚Ä¶');
    let carrierRows = [];
    let pickRows = [];
    try{
      const daySet = new Set(days);
      const bSnap = await db.ref('active_batches').once('value');
      const bObj = bSnap.val() || {};

      // picking by operator (from active_batches)
      const pickMap = {}; // user -> {pickedBatches,pickedIds,pickedProducts}
      Object.values(bObj).filter(Boolean).forEach(b=>{
        const dc = b.dateClean || '';
        if(!daySet.has(dc)) return;
        const u = _u(b.picked_by || b.pickedBy || b.picked_by_user || b.pickedByUser || '');
        if(!u) return;

        if(!pickMap[u]) pickMap[u] = {user:u, pickedBatches:0, pickedIds:0, pickedProducts:0};
        pickMap[u].pickedBatches += 1;

        // IDs: expected minus cancelled
        pickMap[u].pickedIds += _requiredBatchIds(b).length;

        // Products: sum inventory qty, ignoring warranty ES/PT
        const inv = b.inventory || {};
        for(const sku in inv){
          if(!sku) continue;
          if(_ignoreOffSku(sku)) continue; // ignore WARRANTY ES/PT
          const q = Number((inv[sku]||{}).q || 0);
          if(!isNaN(q)) pickMap[u].pickedProducts += q;
        }
      });
      pickRows = Object.values(pickMap).sort((a,b)=> (b.pickedIds-a.pickedIds) || (b.pickedProducts-a.pickedProducts));

      // day -> carrier -> {collectedIds, collectedItems, prodMap}
      const dayCarrierProdMap = {};
      Object.values(bObj).filter(Boolean).forEach(b=>{
        const dc = b.dateClean || '';
        if(!daySet.has(dc)) return;

        const carrier = _carrierName(b);
        const ids = _requiredBatchIds(b);

        if(!dayCarrierProdMap[dc]) dayCarrierProdMap[dc] = {};
        if(!dayCarrierProdMap[dc][carrier]) dayCarrierProdMap[dc][carrier] = {collectedIds:0, collectedItems:0, prodMap:{}};

        const bucket = dayCarrierProdMap[dc][carrier];
        ids.forEach(id=>{
          const key = String(id).trim();
          if(!key) return;
          bucket.collectedIds += 1;
          const prods = packedById[key] || [];
          bucket.collectedItems += prods.length;
          prods.forEach(p=>{
            bucket.prodMap[p] = (bucket.prodMap[p] || 0) + 1;
          });
        });
      });

      // init UI (default: first day in range)
      _initDayCarrier(days, dayCarrierProdMap);
      // OFF (OFFICE) inventory pasted at batch creation: aggregate SKU quantities by carrier

      function _ignoreOffSku(rawSku){
        const s0 = String(rawSku||'').trim();
        if(!s0) return true;
        const up = s0.toUpperCase();
        // Normalize: keep only letters/numbers and spaces
        const norm = up.replace(/[^A-Z0-9 ]+/g,' ').replace(/\s+/g,' ').trim();
        const compact = norm.replace(/\s+/g,'');

        // Match common variants: "warranty es", "WARRANTY_ES", "warranty-pt", etc.
        if(/\bWARRANTY\b\s*\bES\b/.test(norm)) return true;
        if(/\bWARRANTY\b\s*\bPT\b/.test(norm)) return true;
        if(compact === 'WARRANTYES') return true;
        if(compact === 'WARRANTYPT') return true;
        return false;
      }
      const carrierInvMap = {}; // carrier -> {batches,totalQty,skuMap}
      Object.values(bObj).filter(Boolean).forEach(b=>{
        const dc = b.dateClean || '';
        if(!daySet.has(dc)) return;

        const carrier = _carrierName(b);
        if(!carrierInvMap[carrier]) carrierInvMap[carrier] = {carrier, batches:0, totalQty:0, skuMap:{}};
        const bucket = carrierInvMap[carrier];
        bucket.batches += 1;

        const inv = b.inventory || {};
        Object.keys(inv).forEach(sku=>{
          const key = String(sku||'').trim().toUpperCase();
          const keyNorm = key.replace(/\s+/g,' ').trim();
          if(!keyNorm) return;
          if(_ignoreOffSku(sku)) return;
          const qRaw = (inv[sku] && typeof inv[sku]==='object') ? inv[sku].q : inv[sku];
          const q = parseInt(qRaw, 10);
          if(!Number.isFinite(q) || q<=0) return;
          bucket.skuMap[key] = (bucket.skuMap[key]||0) + q;
          bucket.totalQty += q;
        });
      });

      

      // OFF inventory totals for KPI cards
      try{
        const _allCarriers = Object.keys(carrierInvMap||{});
        let _items = 0;
        const _skuSet = new Set();
        _allCarriers.forEach(cc=>{
          const o = carrierInvMap[cc] || {totalQty:0, skuMap:{}};
          _items += (o.totalQty||0);
          Object.keys(o.skuMap||{}).forEach(sku=> _skuSet.add(String(sku)));
        });
        totals.offInvItems = _items;
        totals.offInvSkus = _skuSet.size;
      }catch(_e){ totals.offInvItems = 0; totals.offInvSkus = 0; }
_initOffInventory(carrierInvMap);

      const byC = {}; // carrier -> {country, printedIds,cancelledIds,batches, printedPct (within country), countrySharePct (of total)}

      Object.values(bObj).filter(Boolean).forEach(b=>{
        const dc = b.dateClean || '';
        if(!daySet.has(dc)) return;

        const carrier = _carrierName(b);
        const country = _carrierCountry(carrier);
        const cancelledN = (b && b.cancelled_ids) ? Object.keys(b.cancelled_ids).length : 0;
        const printedN = _requiredBatchIds(b).length; // expected minus cancelled

        if(!byC[carrier]) byC[carrier] = {carrier, country, printedIds:0, cancelledIds:0, batches:0, printedPct:0, countrySharePct:0};
        byC[carrier].printedIds += printedN;
        byC[carrier].cancelledIds += cancelledN;
        byC[carrier].batches += 1;
      });

      carrierRows = Object.values(byC);
      const totalPrinted = carrierRows.reduce((a,r)=>a + (r.printedIds||0), 0);

      const totalPrintedPT = carrierRows.filter(r=>r.country==='PT').reduce((a,r)=>a + (r.printedIds||0), 0);
      const totalPrintedES = carrierRows.filter(r=>r.country==='ES').reduce((a,r)=>a + (r.printedIds||0), 0);
      const totalPrintedOther = totalPrinted - totalPrintedPT - totalPrintedES;

      carrierRows.forEach(r=>{
        const denom = r.country==='PT' ? totalPrintedPT : (r.country==='ES' ? totalPrintedES : totalPrintedOther || totalPrinted);
        r.printedPct = denom ? (r.printedIds/denom) : 0; // % within country group
        r.countrySharePct = totalPrinted ? (r.printedIds/totalPrinted) : 0; // % of total
      });

      // store country shares in totals (for KPIs)
      totals.ptPrintedPct = totalPrinted ? (totalPrintedPT/totalPrinted) : 0;
      totals.esPrintedPct = totalPrinted ? (totalPrintedES/totalPrinted) : 0;


      carrierRows.sort((a,b)=> (b.printedIds - a.printedIds) || a.carrier.localeCompare(b.carrier));

      totals.printedIds = totalPrinted;
      totals.cancelledIds = carrierRows.reduce((a,r)=>a + (r.cancelledIds||0), 0);
    }catch(e){
      console.warn('Carrier analysis failed:', e);
    }

    // render
    _renderKPIs(totals);
    _renderPerfRows(perfRows);
    _renderPickRows(pickRows);
    _renderTopTable('#tbl-sold tbody', soldRows.slice(0,50));
    _renderTopTable('#tbl-ret tbody', retRows.slice(0,50));
    _renderRatio(ratioRows.slice(0,100));
    _renderCarriers(carrierRows);

    // charts
    _renderCharts({days, packed, returns, perfRows, soldRows, retRows, ratioRows, carrierRows});

    // cache export
    __last = {
      range:{start:s,end:e},
      perfRows,
      pickRows,
      soldRows,
      retRows,
      ratioRows,
      carrierRows,
      opProductsMap: packedUserProdMap,
      opReturnsProductsMap: returnsUserProdMap,
      opReturnsIdsMap: returnsUserIdMap,
      dayCarrierProdMap: (window.__dayCarrierProdMap || {}),
      offInvMap: (window.__offInvMap || {}),
      totals
    };

    _setStatus(`OK ‚Ä¢ ${s} ‚Üí ${e} ‚Ä¢ ${packed.length} PACKING ‚Ä¢ ${returns.length} RETURNS`);
  }
  window.runAnalytics = runAnalytics;

  

  // ---------- Charts (Chart.js) ----------
  const __charts = {trend:null, opsIds:null, opsItems:null, retOpsIds:null, retOpsItems:null, sold:null, ret:null, ratio:null, carrierPrinted:null, opRetProds:null, opRetIds:null};

  function _destroyChart(key){
    const c = __charts[key];
    if(c){ try{ c.destroy(); }catch(_e){} }
    __charts[key] = null;
  }

  function _mkBarChart(canvasId, labels, data, title){
    const el = document.getElementById(canvasId);
    if(!el) return null;
    return new Chart(el, {
      type: 'bar',
      data: {
        labels,
        datasets: [{ label: title, data }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true } },
          y: { beginAtZero: true }
        }
      }
    });
  }

  function _renderCharts({days, packed, returns, perfRows, soldRows, retRows, ratioRows, carrierRows}){
    if(typeof Chart === 'undefined') return; // CDN not reachable

    // Trend (daily PACKING vs RETURNS)
    const packByDay = Object.fromEntries(days.map(d=>[d,0]));
    const retByDay  = Object.fromEntries(days.map(d=>[d,0]));
    packed.forEach(x=>{ if(packByDay[x.dateClean] !== undefined) packByDay[x.dateClean]++; });
    returns.forEach(x=>{ if(retByDay[x.dateClean] !== undefined) retByDay[x.dateClean]++; });

    _destroyChart('trend');
    const trendEl = document.getElementById('chart-trend');
    if(trendEl){
      __charts.trend = new Chart(trendEl, {
        type: 'line',
        data: {
          labels: days,
          datasets: [
            { label: 'Packed IDs', data: days.map(d=>packByDay[d]||0), tension: 0.25 },
            { label: 'Return IDs', data: days.map(d=>retByDay[d]||0), tension: 0.25 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Top operators (two views)
    const topOpsByIds = [...(perfRows||[])].sort((a,b)=> (b.packedIds - a.packedIds) || a.user.localeCompare(b.user)).slice(0, 12);
    const topOpsByItems = [...(perfRows||[])].sort((a,b)=> (b.packedProducts - a.packedProducts) || a.user.localeCompare(b.user)).slice(0, 12);

    _destroyChart('opsIds');
    __charts.opsIds = _mkBarChart('chart-ops-ids', topOpsByIds.map(r=>r.user), topOpsByIds.map(r=>r.packedIds), 'Packed IDs');

    _destroyChart('opsItems');
    __charts.opsItems = _mkBarChart('chart-ops-items', topOpsByItems.map(r=>r.user), topOpsByItems.map(r=>r.packedProducts), 'Packed items');

    // Top operators (returns)
    const topRetOpsByIds = [...(perfRows||[])].sort((a,b)=> (b.returnIds - a.returnIds) || a.user.localeCompare(b.user)).slice(0, 12);
    const topRetOpsByItems = [...(perfRows||[])].sort((a,b)=> (b.returnProducts - a.returnProducts) || a.user.localeCompare(b.user)).slice(0, 12);

    _destroyChart('retOpsIds');
    __charts.retOpsIds = _mkBarChart('chart-ret-ops-ids', topRetOpsByIds.map(r=>r.user), topRetOpsByIds.map(r=>r.returnIds), 'Return IDs');

    _destroyChart('retOpsItems');
    __charts.retOpsItems = _mkBarChart('chart-ret-ops-items', topRetOpsByItems.map(r=>r.user), topRetOpsByItems.map(r=>r.returnProducts), 'Returned items');

    // Top sold
    const topSold = (soldRows||[]).slice(0, 15);
    _destroyChart('sold');
    __charts.sold = _mkBarChart('chart-sold', topSold.map(r=>r.product), topSold.map(r=>r.qty), 'Qty sold');

    // Top returns
    const topRet = (retRows||[]).slice(0, 15);
    _destroyChart('ret');
    __charts.ret = _mkBarChart('chart-ret', topRet.map(r=>r.product), topRet.map(r=>r.qty), 'Qty returned');

    // Return rate
    const topRate = (ratioRows||[]).filter(r=>r.sold>=10).slice(0, 15);
    _destroyChart('ratio');
    __charts.ratio = _mkBarChart('chart-ratio', topRate.map(r=>r.product), topRate.map(r=>Math.round(r.rate*1000)/10), 'Return rate (%)');

    // Printed IDs by carrier
    const cr = (carrierRows||[]).slice(0, 20);
    _destroyChart('carrierPrinted');
    __charts.carrierPrinted = _mkBarChart('chart-carrier-printed', cr.map(r=> `${r.country||''} ‚Ä¢ ${r.carrier} (${((r.printedPct||0)*100).toFixed(1)}%)`), cr.map(r=>r.printedIds), 'Printed IDs');

  }

  function _csvEscape(v){
    const s = (v===null||v===undefined) ? '' : String(v);
    if(/[\n\r,\"]/g.test(s)) return '"'+s.replace(/\"/g,'""')+'"';
    return s;
  }

  function _downloadCSV(filename, rows){
    const csv = rows.map(r=>r.map(_csvEscape).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }

  function exportCSV(kind){
    if(!__last || !__last.range || !__last.range.start) return alert('Run analysis first.');
    const tag = `${__last.range.start}_to_${__last.range.end}`;

    if(kind==='performance'){
      const rows = [['User','Packed_IDs','Packed_Products','Return_IDs','Return_Products','Prepack_Scans','Avg_Pack_Seconds','Avg_Return_Seconds']];
      __last.perfRows.forEach(r=>rows.push([r.user,r.packedIds,r.packedProducts,r.returnIds,r.returnProducts,r.prepackScans, r.avgPackSec==null?'':Math.round(r.avgPackSec)]));
      return _downloadCSV(`MURTEDE_Performance_${tag}.csv`, rows);
    }
    if(kind==='picking'){
      const rows = [['User','Picked_Batches','Picked_IDs','Picked_Products']];
      (__last.pickRows||[]).forEach(r=>rows.push([r.user, r.pickedBatches, r.pickedIds, r.pickedProducts]));
      return _downloadCSV(`MURTEDE_Picking_${tag}.csv`, rows);
    }
    if(kind==='sold'){
      const rows = [['Rank','Product','Qty']];
      __last.soldRows.forEach((r,i)=>rows.push([i+1,r.product,r.qty]));
      return _downloadCSV(`MURTEDE_TopSold_${tag}.csv`, rows);
    }
    if(kind==='returns'){
      const rows = [['Rank','Product','Qty']];
      __last.retRows.forEach((r,i)=>rows.push([i+1,r.product,r.qty]));
      return _downloadCSV(`MURTEDE_TopReturns_${tag}.csv`, rows);
    }

    if(kind==='carriers'){
      const rows = [['Country','Carrier','Printed_IDs','Cancelled_IDs','Printed_Pct_Country','Printed_Pct_Total','Batches']];
      (__last.carrierRows||[]).forEach(r=>rows.push([r.country||'', r.carrier,r.printedIds,r.cancelledIds||0, ((r.printedPct||0)*100).toFixed(2)+'%', ((r.countrySharePct||0)*100).toFixed(2)+'%', r.batches]));
      return _downloadCSV(`MURTEDE_Carriers_Printed_${tag}.csv`, rows);
    }

    if(kind==='opproducts'){
      const rows = [['User','Product','Qty']];
      const mp = (__last && __last.opProductsMap) ? __last.opProductsMap : (window.__packedUserProdMap || {});
      Object.keys(mp).sort().forEach(u=>{
        Object.entries(mp[u]||{})
          .sort((a,b)=> b[1]-a[1])
          .forEach(([product,qty])=> rows.push([u, product, qty]));
      });
      return _downloadCSV(`MURTEDE_PackedProducts_ByOperator_${tag}.csv`, rows);
    }

    if(kind==='opreturns_products'){
      const rows = [['User','Product','Qty']];
      const mp = (__last && __last.opReturnsProductsMap) ? __last.opReturnsProductsMap : (window.__returnsUserProdMap || {});
      Object.keys(mp).sort().forEach(u=>{
        Object.entries(mp[u]||{})
          .sort((a,b)=> b[1]-a[1])
          .forEach(([product,qty])=> rows.push([u, product, qty]));
      });
      return _downloadCSV(`MURTEDE_ReturnsProducts_ByOperator_${tag}.csv`, rows);
    }

    if(kind==='opreturns_ids'){
      const rows = [['User','ID','Items']];
      const mp = (__last && __last.opReturnsIdsMap) ? __last.opReturnsIdsMap : (window.__returnsUserIdMap || {});
      Object.keys(mp).sort().forEach(u=>{
        Object.entries(mp[u]||{})
          .sort((a,b)=> (b[1]-a[1]) || String(a[0]).localeCompare(String(b[0])))
          .forEach(([id,items])=> rows.push([u, id, items]));
      });
      return _downloadCSV(`MURTEDE_ReturnsIDs_ByOperator_${tag}.csv`, rows);
    }


    if(kind==='daycarrier'){
      const rows = [['Date','Carrier','Product','Qty','IDs','Items']];
      const mp = (__last && __last.dayCarrierProdMap) ? __last.dayCarrierProdMap : (window.__dayCarrierProdMap || {});
      Object.keys(mp).sort().forEach(dc=>{
        Object.keys(mp[dc]||{}).sort().forEach(carrier=>{
          const bucket = mp[dc][carrier] || {prodMap:{}, collectedIds:0, collectedItems:0};
          Object.entries(bucket.prodMap||{})
            .sort((a,b)=> b[1]-a[1])
            .forEach(([product,qty])=>{
              rows.push([dc, carrier, product, qty, bucket.collectedIds||0, bucket.collectedItems||0]);
            });
        });
      });
      return _downloadCSV(`MURTEDE_Products_ByDayCarrier_${tag}.csv`, rows);
    }

    if(kind==='offinv'){
      const rows = [['Carrier','SKU','Qty','Batches','TotalQtyCarrier']];
      const mp = (__last && __last.offInvMap) ? __last.offInvMap : (window.__offInvMap || {});
      Object.keys(mp).sort().forEach(carrier=>{
        const o = mp[carrier] || {batches:0,totalQty:0,skuMap:{}};
        Object.entries(o.skuMap||{})
          .sort((a,b)=> (b[1]-a[1]) || String(a[0]).localeCompare(String(b[0])))
          .forEach(([sku,qty])=>{
            rows.push([carrier, sku, qty, o.batches||0, o.totalQty||0]);
          });
      });
      return _downloadCSV(`MURTEDE_OFF_Batches_Inventory_${tag}.csv`, rows);
    }

    if(kind==='ratio'){
      const rows = [['Rank','Product','Sold','Returns','Return_Rate']];
      __last.ratioRows.forEach((r,i)=>rows.push([i+1,r.product,r.sold,r.returns,(r.rate*100).toFixed(2)+'%']));
      return _downloadCSV(`MURTEDE_ReturnRate_${tag}.csv`, rows);
    }
  }
  window.exportCSV = exportCSV;

  // init
  (function(){
    const today = _nowISO();
    document.getElementById('start').value = today;
    document.getElementById('end').value = today;

    try{
      firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.database();

      auth.onAuthStateChanged(u=>{
        if(u){
          currentUser = u;
          document.getElementById('login').classList.add('hide');
          document.getElementById('app').classList.remove('hide');
          document.getElementById('userline').innerText = `User: ${u.email || '-'}`;
        }else{
          currentUser = null;
          document.getElementById('login').classList.remove('hide');
          document.getElementById('app').classList.add('hide');
        }
      });

    }catch(e){
      console.error(e);
      document.getElementById('login-msg').innerText = 'Failed to initialize Firebase (open via http://localhost and make sure the CDN is reachable).';
    }
  })();
</script>

</body>
</html>
